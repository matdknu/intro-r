<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Matías Deneken">

<title>CLASE 2 - Introducción a Tidyverse</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="clase2_files/libs/clipboard/clipboard.min.js"></script>
<script src="clase2_files/libs/quarto-html/quarto.js"></script>
<script src="clase2_files/libs/quarto-html/popper.min.js"></script>
<script src="clase2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="clase2_files/libs/quarto-html/anchor.min.js"></script>
<link href="clase2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="clase2_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="clase2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="clase2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="clase2_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">CLASE 2 - Introducción a Tidyverse</h1>
<p class="subtitle lead">Curso de Introducción a R - Observatorio de Legimación de la Violencia (OLES)</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Matías Deneken <a href="mailto:m.deneken@uc.cl" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            CIIR &amp; OLES
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  


</header>


<section id="introducción" class="level2">
<h2 class="anchored" data-anchor-id="introducción">Introducción</h2>
<p>El Observatorio de Violencia y Legitimidad Social (OLES) es una plataforma que desarrolla investigación colaborativa en temáticas relacionadas con la violencia, explorando sus sentidos, formas de justificación, así como las diversas formas en que la sociedad chilena ha desarrollado procesos de construcción de legitimidad social frente a las autoridades, considerando el rol de la justicia como elemento clave en la comprensión de las transformaciones sociales que vive actualmente el país.</p>
<p>Este curso de R buscará introducir a los y las participantes en las nociones básicas del software en su interfaz de R Studio. Para su instalación pueden ver el siguiente vídeo pinchando <a href="https://www.youtube.com/watch?v=RtkCAKXsVbw&amp;t=204s">[Aquí]</a>.</p>
<table class="table">
<caption>Planificación de las sesiones</caption>
<thead>
<tr class="header">
<th>Clases</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Introducción a R</td>
</tr>
<tr class="even">
<td><strong>Procesamiento de Datos Cuantitativos con Tidyverse</strong></td>
</tr>
<tr class="odd">
<td>Estadísticas descriptiva y Visualización de datos con Tidyverse</td>
</tr>
<tr class="even">
<td>Introducción al análisis cuantitativo del texto</td>
</tr>
</tbody>
</table>
</section>
<section id="qué-es-tidyverse" class="level1">
<h1>¿Qué es Tidyverse?</h1>
<p>El proceso de análisis de datos siempre conlleva procedimientos de limpieza de los valores que implican realizar eliminación o generación de nuevos datos. Este proceso es relevante ya que sin datos eficientes y veraces todos los procesos posteriores serán erróneos o poco eficaces.</p>
<p>Además, R trabaja en forma preferente con datos tabulados (en forma de tablas) y su formato preferido es el dataframe. Los datos tabulados establecen:</p>
<ul>
<li><p>Cada variable esta almacenada en su propia columna.</p></li>
<li><p>Cada observación esta almacenada en su propia fila.</p></li>
<li><p>Cada tabla corresponde a un tipo de observación.</p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/tidyverse.png" class="img-fluid figure-img" width="363"></p>
<figcaption>Herramientas y lógica de tidyverse</figcaption>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr) <span class="co"># Importanción de datos</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># Funciones de procesamiento</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2) <span class="co"># Visualización de datos</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl) <span class="co">#Datos de excel</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="la-pipa-de-tidyverse" class="level2">
<h2 class="anchored" data-anchor-id="la-pipa-de-tidyverse">La pipa de Tidyverse <code>%&gt;%</code></h2>
<p>La pipa (<code>%&gt;%</code>) en&nbsp;<code>tidyverse</code>&nbsp;es un operador que facilita la escritura y lectura de código al permitir encadenar una secuencia de operaciones. La pipa toma la salida de una función y la pasa como entrada a la siguiente función, lo que hace que el código sea más limpio y más fácil de entender.</p>
<p>Una forma fácil de realizar es con <code>ctrl/command</code> + <code>shift</code> + <code>m</code>.</p>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="images/mipa-magrit.jpeg" class="img-fluid quarto-figure quarto-figure-left figure-img" width="197"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-right">
<figure class="figure">
<p><img src="images/pipa-tidyvers.webp" class="img-fluid quarto-figure quarto-figure-right figure-img" width="200"></p>
</figure>
</div>
</section>
<section id="funciones-básicas" class="level2">
<h2 class="anchored" data-anchor-id="funciones-básicas">Funciones básicas</h2>
<section id="primer-paso-importación-de-base-de-datos" class="level3">
<h3 class="anchored" data-anchor-id="primer-paso-importación-de-base-de-datos">Primer paso: Importación de base de datos</h3>
<p>Importaremos una base de datos de acuerdo al paquete readxl, puesto que el paquete readr no agota toda la importación de los datos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>eventos <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">"bbdd/eventos_22_24.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Otra forma de importar los datos es directamente desde github.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://github.com/matdknu/intro-r/raw/main/bbdd/eventos_22_24.xlsx"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear un archivo temporal</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>temp_file <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".xlsx"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Descargar el archivo desde GitHub</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">GET</span>(url, <span class="fu">write_disk</span>(temp_file, <span class="at">overwrite =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Response [https://raw.githubusercontent.com/matdknu/intro-r/main/bbdd/eventos_22_24.xlsx]
  Date: 2024-08-04 22:58
  Status: 200
  Content-Type: application/octet-stream
  Size: 3.08 MB
&lt;ON DISK&gt;  /var/folders/hg/s4skq8ks6g1fy2jw2fdkp0840000gn/T//RtmpdyD6SY/file2fdc1138a3f8.xlsx</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Leer el archivo Excel en R</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>eventos <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(temp_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/captura-link.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="procesamiento-de-base-de-datos" class="level3">
<h3 class="anchored" data-anchor-id="procesamiento-de-base-de-datos">Procesamiento de base de datos</h3>
<p>Explorando la base de datos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(eventos) <span class="co"># Verificar la base de datos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 6,090
Columns: 9
$ MOTIVO                &lt;chr&gt; "Social (Otras agrupaciones)", "Social (Otras ag…
$ TIPO                  &lt;chr&gt; "Manifestación", "Concentración", "Manifestación…
$ REGION                &lt;chr&gt; "V REGION VALPARAISO", "REGION METROPOLITANA", "…
$ `CANTIDAD ASISTENTES` &lt;dbl&gt; 30, 40, 70, 50, 25, 25, 100, 60, 70, 15, 5, 15, …
$ `FECHA INICIO`        &lt;dttm&gt; 2022-12-31, 2022-12-30, 2022-12-30, 2022-12-30,…
$ `HORA INICIO`         &lt;dttm&gt; 1899-12-31 08:30:00, 1899-12-31 18:30:00, 1899-…
$ `FECHA TERMINO`       &lt;dttm&gt; 2022-12-31, 2022-12-30, 2022-12-30, 2022-12-30,…
$ `HORA TERMINO`        &lt;dttm&gt; 1899-12-31 11:00:00, 1899-12-31 21:50:00, 1899-…
$ ...9                  &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …</code></pre>
</div>
</div>
<p>Se aprecia que la base de datos tienen nombres que complejizan su manipulación. Un correcto nombre de variables debe ser</p>
<ul>
<li><p>Minúsculas</p></li>
<li><p>Sin espacios</p></li>
<li><p>Sin números.</p></li>
</ul>
<p>El R base nos ofrece algunas herramientos para su correcto renombramiento.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(eventos)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"motivo"</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(eventos)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">"tipo"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(eventos)[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">"region"</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(eventos)[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">"n_asistentes"</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(eventos)[<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="st">"fecha_inicio"</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(eventos)[<span class="dv">6</span>] <span class="ot">&lt;-</span> <span class="st">"hora_inicio"</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(eventos)[<span class="dv">7</span>] <span class="ot">&lt;-</span> <span class="st">"fecha_termino"</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(eventos)[<span class="dv">8</span>] <span class="ot">&lt;-</span> <span class="st">"hora_termino"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Tidyverse lo ofrece de la siguiente forma (Ojo, si ya corrieron el código de arriba les saldrá ERROR).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>eventos <span class="ot">&lt;-</span> eventos <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">motivo =</span> <span class="st">"MOTIVO"</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">tipo =</span> <span class="st">"TIPO"</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">region =</span> <span class="st">"REGION"</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_asistentes =</span> <span class="st">"CANTIDAD ASISTENTES"</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">fecha_inicio =</span> <span class="st">"FECHA INICIO"</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">hora_inicio =</span> <span class="st">"HORA INICIO"</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">fecha_termino =</span> <span class="st">"FECHA TERMINO"</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">hora_termino =</span> <span class="st">"HORA TERMINO"</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Seleccionamos las variables de interés con el comando select.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>eventos <span class="sc">%&gt;%</span> <span class="fu">select</span>(motivo, region) <span class="co"># Variable(s) de interés.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,090 × 2
   motivo                        region              
   &lt;chr&gt;                         &lt;chr&gt;               
 1 Social (Otras agrupaciones)   V REGION VALPARAISO 
 2 Social (Otras agrupaciones)   REGION METROPOLITANA
 3 Social (Otras agrupaciones)   REGION METROPOLITANA
 4 Género (Feminista)            X REGION LOS LAGOS  
 5 Laboral                       X REGION LOS LAGOS  
 6 Laboral (Sindicato o empresa) VIII REGION BIO BIO 
 7 Social (Otras agrupaciones)   REGION METROPOLITANA
 8 Laboral                       REGION METROPOLITANA
 9 Laboral                       REGION METROPOLITANA
10 Social                        REGION METROPOLITANA
# ℹ 6,080 more rows</code></pre>
</div>
</div>
<p>Filtramos con filter:</p>
<ul>
<li><p>Cuando los casos de las variables son de tipo texto, deben ir en comillas. Por ejemplo <code>"Paro Nacional"</code></p></li>
<li><p>Cuando los casos de la variable son de tipo número, van sin comillas. Por ejemplo: <code>2000.</code></p></li>
</ul>
<p>Primero, queremos solo los eventos con motivo laboral.</p>
<p>Segundo, queremos los eventos con motivo laboral que ocurrieron en la región de valparaíso.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>eventos <span class="sc">%&gt;%</span> <span class="fu">filter</span>(motivo <span class="sc">==</span> <span class="st">"Laboral"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 188 × 9
   motivo  tipo      region n_asistentes fecha_inicio        hora_inicio        
   &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;         &lt;dbl&gt; &lt;dttm&gt;              &lt;dttm&gt;             
 1 Laboral Manifest… X REG…           25 2022-12-30 00:00:00 1899-12-31 14:15:00
 2 Laboral Manifest… REGIO…           60 2022-12-29 00:00:00 1899-12-31 14:15:00
 3 Laboral Manifest… REGIO…           70 2022-12-29 00:00:00 1899-12-31 10:40:00
 4 Laboral Desorden… X REG…           40 2022-12-20 00:00:00 1899-12-31 14:20:00
 5 Laboral Desorden… X REG…           40 2022-12-19 00:00:00 1899-12-31 09:20:00
 6 Laboral Concentr… VIII …           40 2022-12-15 00:00:00 1899-12-31 11:00:00
 7 Laboral Concentr… VIII …           50 2022-12-07 00:00:00 1899-12-31 14:50:00
 8 Laboral Manifest… X REG…           22 2022-12-06 00:00:00 1899-12-31 11:30:00
 9 Laboral Concentr… VI RE…           37 2022-11-26 00:00:00 1899-12-31 10:50:00
10 Laboral Manifest… VIII …           50 2022-11-24 00:00:00 1899-12-31 10:15:00
# ℹ 178 more rows
# ℹ 3 more variables: fecha_termino &lt;dttm&gt;, hora_termino &lt;dttm&gt;, ...9 &lt;lgl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>eventos <span class="sc">%&gt;%</span> <span class="fu">filter</span>(motivo <span class="sc">==</span> <span class="st">"Laboral"</span>, region <span class="sc">==</span> <span class="st">"V REGION VALPARAISO"</span>) <span class="co">#Filtramos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 28 × 9
   motivo  tipo      region n_asistentes fecha_inicio        hora_inicio        
   &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;         &lt;dbl&gt; &lt;dttm&gt;              &lt;dttm&gt;             
 1 Laboral Marcha c… V REG…           20 2022-09-15 00:00:00 1899-12-31 11:00:00
 2 Laboral Manifest… V REG…           35 2022-09-14 00:00:00 1899-12-31 09:40:00
 3 Laboral Manifest… V REG…           30 2022-09-12 00:00:00 1899-12-31 11:30:00
 4 Laboral HUELGAS   V REG…           70 2022-09-01 00:00:00 1899-12-31 08:40:00
 5 Laboral Manifest… V REG…           20 2022-09-01 00:00:00 1899-12-31 08:30:00
 6 Laboral Manifest… V REG…            1 2022-07-29 00:00:00 1899-12-31 13:45:00
 7 Laboral Marcha s… V REG…           20 2022-07-20 00:00:00 1899-12-31 09:00:00
 8 Laboral Manifest… V REG…           15 2022-06-01 00:00:00 1899-12-31 12:00:00
 9 Laboral Concentr… V REG…           20 2022-05-01 00:00:00 1899-12-31 12:00:00
10 Laboral Marcha s… V REG…           15 2022-04-08 00:00:00 1899-12-31 16:20:00
# ℹ 18 more rows
# ℹ 3 more variables: fecha_termino &lt;dttm&gt;, hora_termino &lt;dttm&gt;, ...9 &lt;lgl&gt;</code></pre>
</div>
</div>
<p>Apliquemos ¿Cuál creen que es correcto para el uso de datos?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>eventos <span class="ot">&lt;-</span> eventos <span class="sc">%&gt;%</span> <span class="fu">filter</span>(motivo <span class="sc">==</span> <span class="st">"Laboral"</span>, region <span class="sc">==</span> <span class="st">"V REGION VALPARAISO"</span>) <span class="co">#Filtramos</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>eventos_valparaiso <span class="ot">&lt;-</span> eventos <span class="sc">%&gt;%</span> <span class="fu">filter</span>(motivo <span class="sc">==</span> <span class="st">"Laboral"</span>, region <span class="sc">==</span> <span class="st">"V REGION VALPARAISO"</span>) <span class="co">#Filtramos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Hagamos un filtro numérico con operadores lógicos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>eventos100 <span class="ot">&lt;-</span>eventos <span class="sc">%&gt;%</span> <span class="fu">filter</span>(n_asistentes <span class="sc">==</span> <span class="dv">100</span>) </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(eventos100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
  motivo       tipo  region n_asistentes fecha_inicio        hora_inicio        
  &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt;         &lt;dbl&gt; &lt;dttm&gt;              &lt;dttm&gt;             
1 Social (Otr… Mani… REGIO…          100 2022-12-30 00:00:00 1899-12-31 09:15:00
2 Social       Mani… XII R…          100 2022-12-22 00:00:00 1899-12-31 14:00:00
3 Social       Mani… I REG…          100 2022-12-21 00:00:00 1899-12-31 13:45:00
4 Social (Otr… Conc… REGIO…          100 2022-12-17 00:00:00 1899-12-31 12:00:00
5 Social (Otr… Conc… REGIO…          100 2022-12-16 00:00:00 1899-12-31 09:15:00
6 Laboral (Si… Marc… REGIO…          100 2022-12-12 00:00:00 1899-12-31 11:00:00
# ℹ 3 more variables: fecha_termino &lt;dttm&gt;, hora_termino &lt;dttm&gt;, ...9 &lt;lgl&gt;</code></pre>
</div>
</div>
<p>Combinemos algunas funciones</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>eventos100 <span class="ot">&lt;-</span>eventos <span class="sc">%&gt;%</span> <span class="fu">filter</span>(n_asistentes <span class="sc">==</span> <span class="dv">100</span>)<span class="sc">%&gt;%</span> <span class="fu">select</span>(tipo, region, fecha_inicio)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(eventos100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  tipo                    region                             fecha_inicio       
  &lt;chr&gt;                   &lt;chr&gt;                              &lt;dttm&gt;             
1 Manifestación           REGION METROPOLITANA               2022-12-30 00:00:00
2 Manifestación           XII REGION MAGALLANES Y ANT.CHILE… 2022-12-22 00:00:00
3 Manifestación           I REGION TARAPACA                  2022-12-21 00:00:00
4 Concentración           REGION METROPOLITANA               2022-12-17 00:00:00
5 Concentración           REGION METROPOLITANA               2022-12-16 00:00:00
6 Marcha sin autorización REGION METROPOLITANA               2022-12-12 00:00:00</code></pre>
</div>
</div>
<p>Crear nuevas variables desde cero o a partir de las ya existentes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>eventos <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">anio_actual =</span> <span class="dv">2024</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(tipo, region, fecha_inicio, anio_actual)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,090 × 4
   tipo                    region               fecha_inicio        anio_actual
   &lt;chr&gt;                   &lt;chr&gt;                &lt;dttm&gt;                    &lt;dbl&gt;
 1 Manifestación           V REGION VALPARAISO  2022-12-31 00:00:00        2024
 2 Concentración           REGION METROPOLITANA 2022-12-30 00:00:00        2024
 3 Manifestación           REGION METROPOLITANA 2022-12-30 00:00:00        2024
 4 Marcha con autorización X REGION LOS LAGOS   2022-12-30 00:00:00        2024
 5 Manifestación           X REGION LOS LAGOS   2022-12-30 00:00:00        2024
 6 Manifestación           VIII REGION BIO BIO  2022-12-30 00:00:00        2024
 7 Manifestación           REGION METROPOLITANA 2022-12-30 00:00:00        2024
 8 Manifestación           REGION METROPOLITANA 2022-12-29 00:00:00        2024
 9 Manifestación           REGION METROPOLITANA 2022-12-29 00:00:00        2024
10 Manifestación           REGION METROPOLITANA 2022-12-29 00:00:00        2024
# ℹ 6,080 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>eventos <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">manifestantes_cien =</span> n_asistentes <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(manifestantes_cien, n_asistentes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,090 × 2
   manifestantes_cien n_asistentes
                &lt;dbl&gt;        &lt;dbl&gt;
 1               3000           30
 2               4000           40
 3               7000           70
 4               5000           50
 5               2500           25
 6               2500           25
 7              10000          100
 8               6000           60
 9               7000           70
10               1500           15
# ℹ 6,080 more rows</code></pre>
</div>
</div>
<p>Crear una nueva variable con <code>case_when</code> .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>eventos <span class="ot">&lt;-</span> eventos <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cat_asistentes =</span> <span class="fu">case_when</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    n_asistentes <span class="sc">&lt;</span> <span class="dv">250</span> <span class="sc">~</span> <span class="st">"Pequeña"</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    n_asistentes <span class="sc">&gt;=</span> <span class="dv">250</span> <span class="sc">&amp;</span> n_asistentes <span class="sc">&lt;=</span> <span class="dv">1000</span> <span class="sc">~</span> <span class="st">"Mediana"</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    n_asistentes <span class="sc">&gt;</span> <span class="dv">1000</span> <span class="sc">~</span> <span class="st">"Masiva"</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>eventos <span class="sc">%&gt;%</span> <span class="fu">select</span>(cat_asistentes, n_asistentes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,090 × 2
   cat_asistentes n_asistentes
   &lt;chr&gt;                 &lt;dbl&gt;
 1 Pequeña                  30
 2 Pequeña                  40
 3 Pequeña                  70
 4 Pequeña                  50
 5 Pequeña                  25
 6 Pequeña                  25
 7 Pequeña                 100
 8 Pequeña                  60
 9 Pequeña                  70
10 Pequeña                  15
# ℹ 6,080 more rows</code></pre>
</div>
</div>
<p>Usemos la función count para contar cuantas de ellas existen:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>eventos <span class="sc">%&gt;%</span> <span class="fu">count</span>(cat_asistentes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  cat_asistentes     n
  &lt;chr&gt;          &lt;int&gt;
1 Masiva            82
2 Mediana          329
3 Pequeña         5679</code></pre>
</div>
</div>
</section>
<section id="función-group_by" class="level3">
<h3 class="anchored" data-anchor-id="función-group_by">Función: <code>Group_by</code></h3>
<p>Una función que requiere un mayor nivel de abstracción es <code>group_by</code> .</p>
<p>La función&nbsp;<code>group_by()</code>&nbsp;en&nbsp;<code>dplyr</code>, que es parte del&nbsp;<code>tidyverse</code>, se utiliza para agrupar filas de un dataframe según una o más variables. Esta agrupación permite realizar operaciones agregadas en subconjuntos de datos, lo que es útil para resumir información, calcular estadísticas agrupadas y realizar transformaciones específicas por grupo.</p>
<p>Por ejemplo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>protestas_region <span class="ot">&lt;-</span> eventos <span class="sc">%&gt;%</span> <span class="fu">select</span>(motivo, region) <span class="sc">%&gt;%</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(motivo)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(protestas_region)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
# Groups:   region [1]
  region            motivo                                 n
  &lt;chr&gt;             &lt;chr&gt;                              &lt;int&gt;
1 I REGION TARAPACA Ambientalista                          1
2 I REGION TARAPACA Estudiantil                            1
3 I REGION TARAPACA Estudiantil (Educación secundaria)     4
4 I REGION TARAPACA Estudiantil (Educación superior)       1
5 I REGION TARAPACA Género                                 1
6 I REGION TARAPACA Género (Feminista)                     6</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>protestas_region_filtrada <span class="ot">&lt;-</span> eventos <span class="sc">%&gt;%</span> <span class="fu">select</span>(motivo, region) <span class="sc">%&gt;%</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span> </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(motivo) <span class="sc">%&gt;%</span> </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">20</span>) <span class="co">#Mayores que 20</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(protestas_region_filtrada)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
# Groups:   region [5]
  region                motivo                           n
  &lt;chr&gt;                 &lt;chr&gt;                        &lt;int&gt;
1 I REGION TARAPACA     Social                          28
2 II REGION ANTOFAGASTA Laboral (Colegio profesores)    25
3 II REGION ANTOFAGASTA Social                          28
4 III REGION ATACAMA    Laboral (Colegio profesores)    24
5 IV REGION COQUIMBO    Social (Otras agrupaciones)     35
6 IX REGION ARAUCANIA   Étnico                         153</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>masividad_protestas_region <span class="ot">&lt;-</span> eventos <span class="sc">%&gt;%</span> <span class="fu">select</span>(cat_asistentes, region) <span class="sc">%&gt;%</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(cat_asistentes) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>